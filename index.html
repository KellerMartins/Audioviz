<!DOCTYPE html>
<html>
  <head>
    <title>Audio Receiver</title>
    <style>
      #visualizer {
        width: 100%;
        height: 100px;
        background-color: #eee;
      }
    </style>
  </head>
  <body>
    <h1>Audio Receiver</h1>
    <audio id="audioPlayer" controls></audio>
    <button id="startButton" style="display: none">Start Audio</button>

    <script>
      let audioContext;
      let analyser;
      let dataArray;
      let bufferLength;
      let contentScriptReady = false;
      let mediaSource;
      let sourceBuffer;
      let audioPlayer;
      let sourceNode;

      function setupMediaSource() {
        if (mediaSource) return;

        console.log("target.html: Setting up MediaSource");
        mediaSource = new MediaSource();
        audioPlayer.src = URL.createObjectURL(mediaSource);

        mediaSource.addEventListener("sourceopen", handleSourceOpen);
        mediaSource.addEventListener("sourceended", () =>
          console.log("target.html: MediaSource ended")
        );
        mediaSource.addEventListener("sourceclose", () =>
          console.log("target.html: MediaSource closed")
        );
      }

      function handleSourceOpen() {
        console.log("target.html: MediaSource opened");
        sourceBuffer = mediaSource.addSourceBuffer("audio/webm; codecs=opus");

        sourceBuffer.addEventListener("updateend", () => {
          if (audioPlayer.paused) {
            audioPlayer.play().catch((error) => {
              console.error("Playback error:", error);
            });
          }
        });

        sourceBuffer.addEventListener("error", (e) => {
          console.error("target.html: SourceBuffer error:", e);
        });

        sourceBuffer.addEventListener("abort", () => {
          console.log("target.html: SourceBuffer aborted");
        });
      }
      function requestAudio() {
        console.log("target.html: requestAudio called");
        if (contentScriptReady) {
          window.postMessage(
            { type: "fromWebPage", action: "requestAudio" },
            "*"
          );
        } else {
          console.warn(
            "target.html: Content script not ready yet, delaying requestAudio"
          );
        }
      }

      window.addEventListener(
        "message",
        async (event) => {
          if (event.source === window && Array.isArray(event.data)) {
            // console.log("target.html: Received chunk size:", event.data.length);

            setupMediaSource();

            try {
              const uint8Array = new Uint8Array(event.data);
              if (sourceBuffer && !sourceBuffer.updating) {
                sourceBuffer.appendBuffer(uint8Array);
              } else {
                console.warn(
                  "target.html: SourceBuffer not ready or updating, dropping chunk"
                );
              }
            } catch (error) {
              console.error("Error processing audio chunk:", error);
            }
          } else if (
            event.source === window &&
            event.data.type === "fromContentScript"
          ) {
            if (event.data.ready) {
              console.log("target.html: Content script is ready!");
              contentScriptReady = true;
              startButton.style.display = "block";
            } else if (event.data.streamEnded) {
              console.log("target.html: Stream ended");
              audioPlayer.pause();
            }
          }
        },
        false
      );

      audioPlayer = document.getElementById("audioPlayer");
      startButton = document.getElementById("startButton");
      startButton.addEventListener("click", () => {
        setupMediaSource(); // Prepare MediaSource
        requestAudio();
        console.log("Start!");
      });

      console.log("target.html: Script loaded");
    </script>
  </body>
</html>
